// Generated by CoffeeScript 1.10.0
(function() {
  'use strict';
  var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  define(['text!/Pages/play/home.html', 'avalon', 'api', 'page', 'avalon.cookie', 'select2'], function(pageMain, avalon, api, page) {
    var vm;
    avalon.templateCache.play_home = pageMain;
    vm = avalon.define({
      $id: 'home',
      mod: avalon.vmodels.play.mod,
      host: avalon.vmodels.play.host,
      service: avalon.vmodels.play.service,
      uid: avalon.vmodels.play.uid,
      url: null,
      loading: '/Assets/logic/common/loading.html',
      currentPage: 1,
      pageHtml: '',
      nextPage: function() {
        vm.currentPage++;
        return avalon.router.navigate('play:home?platform=' + vm.platform + '&query=' + vm.searchQuery + '&page=' + vm.currentPage);
      },
      rePage: function() {
        vm.currentPage--;
        return avalon.router.navigate('play:home?platform=' + vm.platform + '&query=' + vm.searchQuery + '&page=' + vm.currentPage);
      },
      total: 0,
      searchQuery: '',
      order: 'sorts.',
      direction: 'desc',
      platform: 0,
      bg_colors: ['#9f5f9f', '#a67d3d', '#42426f'],
      rand_bg: function(el) {
        var limg, ref;
        if (el['imgs'] && el['imgs'][vm.uid]) {
          limg = vm.host + el['imgs'][vm.uid];
        } else {
          if (ref = el.platform, indexOf.call(NOTSHOWIMG_PLATFORM, ref) >= 0) {
            limg = '/images/default.png';
          } else {
            limg = el['img'];
          }
        }
        return 'url(' + limg + ')';
      },
      rand_bgcolor: function() {
        var index;
        index = parseInt(Math.random() * 3) + 1;
        return vm.bg_colors[index - 1];
      },
      submitSearch: function(e) {
        var query;
        e.preventDefault();
        query = $("input[name='query']").val();
        if (query.trim()) {
          return avalon.router.navigate('play:home?query=' + query);
        }
      },
      error: '',
      emptyList: function(status) {
        if (status == null) {
          status = [];
        }
        return vm.error = status;
      },
      changePlatform: function(platform) {
        vm.platform = platform;
        vm.currentPage = 1;
        return vm.getCategory();
      },
      count: 12,
      totalPage: 0,
      showNextPage: false,
      onLoading: false,
      cateList: [],
      firstGet: true,
      exeCategory: function(result) {
        if (SUCCESS === result.code) {
          vm.emptyList();
          vm.cateList = result.list;
          vm.total = result.total;
          vm.totalPage = Math.ceil(result.total / parseInt(vm.count));
          vm.pageHtml = page.getPage(vm.currentPage, vm.totalPage, vm.url, 'play:home');
          return setTimeout(function() {
            return $("#FocusMovie0").focus();
          }, 200);
        } else if (ISEMPTY === result.code) {
          return vm.emptyList(false);
        } else {
          return require(['logic/common/tips'], function(tips) {
            return tips.showTips(result.msg, 'error');
          });
        }
      },
      getCategory: function() {
        vm.cateList = [];
        vm.emptyList('loading');
        return api.getApi('/videoset/get_resList', {
          'page': vm.currentPage,
          'count': vm.count,
          'query': vm.searchQuery,
          'order': vm.order + vm.uid,
          'direction': -1,
          'type': 'dledAndDlAtlastone'
        }, function(result) {
          return vm.exeCategory(result);
        });
      },
      init: function(url) {
        avalon.log('task home page load complete');
        vm.url = url;
        vm.currentPage = vm.url.page ? vm.url.page : 1;
        vm.platform = vm.url.platform ? vm.url.platform : 0;
        vm.searchQuery = vm.url.query ? vm.url.query : '';
        vm.getCategory();
        avalon.vmodels.play.title = '';
        return document.title = _siteName;
      }
    });
    return vm;
  });

}).call(this);

//# sourceMappingURL=home.js.map
